miss_spsu
=========

Система онлайн-голосования для конкурса «Мисс ПГУ». изначально была написана для «Мисс ФМФ» и «Мисс ПГУ — 2017».


Подготовка к работе
-------------------

Для работы системы необходимо:

- создать список участниц,
- подготовить уникальные номера для голосования
- и создать файл с настройками.

Пример списка участниц находится в `girls.csv`. Его можно редактировать в MS Excel или LibreOffice Calc.
Кодировка должна быть UTF-8.

Для подготовки номеров достаточно запустить скрипт `misc/generate.py`. Он создаст файл `numbers.txt` в
котором будет 560 уникальных номеров.

Чтоб сгенерировать билетики, откройте `misc/Мисс ПГУ.docm` и запустите макрос `Numbers` из иснструментов разработчика.
Далее потребуется указать файл `numbers.txt`. После завершения работы макроса в документе будет готовый макет билетов
для печати и разрезания.

Пример файла с настройками можно найти в `misc/miss_spsu.ini`.

Не забудьте поменять ключ приложения и пароль администратора!


Развёртывание
-------------

Для запуска используется Docker.

Сборка контейнера производится как обычно:

```bash
sudo docker build -t miss_spsu .
``` 

Подготовьте директорию, где будут храниться настройки и база (например, `/home/user/data``).
В ней должны быть файлы, созданные ранее:

- `girls.csv`
- `miss_spsu.ini`
- `numbers.txt`

Для запуска контейнера выполните:

```bash
sudo docker run -v /home/user/data/:/data -p 3031:3031 -t miss_spsu
```

После запуска в этой же директории будет находится файл с базой данных.

Внимание! Каждый запуск перезаписывает базу. Не забудьте сделать бэкап,
если хотите потом проанализировать результаты.  

Для работы достаточно минимального дроплета на Digital Ocean (c 512 Мбайт ОЗУ без подкачки).
Система успешно выдержала запросы от приблизительно 500 человек в течение нескольких минут.

Порт 3031 — это порт веб-приложения, которое взаимодействует с внешним миром по протоколу WSGI.
пример настройки Nginx можно найти в `misc/miss.spsu.ru`.

Работа
------

По адресу https://miss.spsu.ru/ находится сама голосовалка. Дизайн рассчитан на мобильные устройства.
На десктопе всё плохо. Если голосование включено, то можно голосовать за несколько участниц.

По адресу https://miss.spsu.ru/stat — статистика для вывода на проектор. Рассчитана на разрешение 800×600.
Обновляется автоматически каждые две секунды.

По адресу https://miss.spsu.ru/admin — включение и выключение голосования, загрузка номеров.

CSS- и JS-фреймворки не самые лёкие, так что страничка в первый раз может загружаться несколько секунд
через мобильный интернет.


Защита от накруток
------------------

При попытке подобрать номер сначала блокируется на 20 секунд браузер.
Если продолжать — то на 90 секунд блокируется весь IP.

В Redis ведётся лог (ключ `log`).
Записывается время, ключ сессии, выбор, ответ сервера.
По логам можно отследить «накрутки» голосов (разумеется, пост-фактум).
